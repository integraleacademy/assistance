<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Archives - Int√©grale Academy</title>
  <style>
    body {background-color:#fdfaf5; font-family:Arial, sans-serif; margin:0; padding:20px;}
    .container {background:white; padding:20px; border-radius:15px; box-shadow:0 0 15px rgba(0,0,0,0.1);}
    table {width:100%; border-collapse:collapse; font-size:14px; table-layout: fixed;}
    th, td {border:1px solid #ddd; padding:10px; text-align:center; vertical-align:middle; word-wrap:break-word;}
    th {background:#f4c45a;}
    input[type="text"] {padding:6px; border-radius:6px; border:1px solid #ccc; width:280px;}
    .search {margin-bottom:15px; display:flex; gap:8px; align-items:center;}
    a {text-decoration:none; color:#0d6efd;}
    .topbar {display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;}
    .back {display:inline-block; padding:8px 14px; background:#6c757d; color:#fff; border-radius:8px;}
    .status-red {color:#fff; background-color:#dc3545; font-weight:bold; padding:4px 8px; border-radius:5px;}
    .status-green {color:#fff; background-color:#198754; font-weight:bold; padding:4px 8px; border-radius:5px;}
    .pj-cell {min-width: 200px; max-width: 240px; overflow: hidden;}
    .pj-wrap {display: flex; flex-wrap: wrap; gap: 6px; justify-content: flex-start;}
    .pj-chip { display: inline-flex; align-items: center; gap: 6px; max-width: 100%; min-width: 0; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 9999px; background: #f8f9fa; }
    .pj-name { flex: 1 1 auto; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color:#0d6efd; text-decoration: none; }
    .pj-empty {color:#999; font-size:12px;}
    .dup-badge {color:#dc3545; font-weight:bold; margin-left:6px;}
    .del-btn {background:#dc3545; color:#fff; border:none; padding:4px 8px; border-radius:6px; cursor:pointer;}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h2>üì¶ Archives des demandes</h2>
      <a class="back" href="{{ url_for('admin') }}">‚¨ÖÔ∏è Retour admin</a>
    </div>

    <!-- Bouton vider toutes les archives -->
    <form method="POST" style="margin-bottom:15px;">
      <button type="submit" name="action" value="clear" 
              onclick="return confirm('Supprimer toutes les archives ?')" 
              style="background:#dc3545; color:#fff; border:none; padding:6px 12px; border-radius:8px; cursor:pointer;">
        üóëÔ∏è Vider toutes les archives
      </button>
    </form>

    <!-- Barre de recherche -->
    <form method="GET" class="search">
      <input type="text" name="q" placeholder="Rechercher (nom, pr√©nom, mail, motif, d√©tails)" value="{{ query }}">
      <button type="submit">üîç Rechercher</button>
    </form>

    <table>
      <tr>
        <th>Nom</th>
        <th>Pr√©nom</th>
        <th>Email</th>
        <th>Motif</th>
        <th>D√©tails</th>
        <th>Justificatif</th>
        <th>Pi√®ces jointes</th>
        <th>Date</th>
        <th>Attribu√© √†</th>
        <th>Statut</th>
        <th>Commentaire</th>
        <th>Mail</th>
        <th>Actions</th>
      </tr>
      {% for a in archives %}
      <tr>
        <td>{{ a.nom }} {% if a.is_doublon %}<span class="dup-badge">‚ö†Ô∏è Doublon</span>{% endif %}</td>
        <td>{{ a.prenom }}</td>
        <td>{{ a.mail }}</td>
        <td>{{ a.motif }}</td>
        <td style="text-align:left">{{ a.details }}</td>

        <!-- Justificatif -->
        <td>
          {% if a.justificatif %}
            <a href="{{ url_for('download_file', filename=a.justificatif) }}" target="_blank">üìé Voir</a>
          {% else %}
            <span class="pj-empty">‚Äî</span>
          {% endif %}
        </td>

        <!-- Pi√®ces jointes -->
        <td class="pj-cell">
          <div class="pj-wrap">
            {% if a.pieces_jointes and a.pieces_jointes|length > 0 %}
              {% for pj in a.pieces_jointes %}
              <div class="pj-chip" title="{{ pj }}">
                <span>üìé</span>
                <a class="pj-name" href="{{ url_for('download_file', filename=pj) }}" target="_blank">{{ pj }}</a>
              </div>
              {% endfor %}
            {% else %}
              <span class="pj-empty">‚Äî</span>
            {% endif %}
          </div>
        </td>

        <td>{{ a.date }}</td>
        <td>{{ a.attribution or "‚Äî" }}</td>

        <!-- Statut -->
        <td>
          {% if a.statut == "Non trait√©" %}
            <span class="status-red">Non trait√©</span>
          {% else %}
            <span class="status-green">Trait√©</span>
          {% endif %}
        </td>

        <!-- Commentaire -->
        <td style="text-align:left">{{ a.commentaire or "‚Äî" }}</td>

        <!-- Mail -->
        <td>
          {% if a.mail_confirme %}
            ‚úÖ Envoy√© le {{ a.mail_confirme }}
          {% elif a.mail_erreur %}
            ‚ùå {{ a.mail_erreur }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>

        <!-- Actions -->
        <td>
          <form method="POST" style="margin:0;">
            <input type="hidden" name="id" value="{{ a.id }}">
            <button type="submit" name="action" value="delete_one" 
                    onclick="return confirm('Supprimer cette archive ?')" 
                    class="del-btn">üóëÔ∏è</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      {% if archives|length == 0 %}
      <tr><td colspan="13">Aucune archive trouv√©e.</td></tr>
      {% endif %}
    </table>
  </div>
</body>
</html>
