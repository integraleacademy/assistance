<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Administration - Int√©grale Academy</title>
    <style>
        body {background-color: #fdfaf5; font-family: Arial, sans-serif; margin:0; padding:20px;}
        .container {width: 100%; background: white; padding: 20px; border-radius: 15px;
                    box-shadow: 0 0 15px rgba(0,0,0,0.1); box-sizing: border-box; overflow-x:auto;}
        img.logo {max-width: 120px; display: block; margin: 0 auto 20px;}
        h2 {text-align: center; margin-bottom: 10px;}
        #last-update {text-align:center; margin-bottom:5px; font-size:14px; color:#666;}
        #debug {text-align:center; margin-bottom:20px; font-size:12px; color:#555;}
        table {width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 14px;}
        th, td {border: 1px solid #ddd; padding: 10px; text-align: center; vertical-align: middle; word-wrap: break-word;}
        th {background-color: #f4c45a; color: #333;}
        select, textarea, input[type="text"] {padding: 5px; border-radius: 5px; border: 1px solid #ccc; width: 90%;}
        .actions button, .actions a {padding: 6px 10px; margin: 2px; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;}
        .save {background-color: #198754; color: white;}
        .delete {background-color: #dc3545; color: white;}
        .print {background-color: #0d6efd; color: white; text-decoration: none; display: inline-block;}
        .status-red {color: #fff; background-color: #dc3545; font-weight: bold; padding: 4px 8px; border-radius: 5px;}
        .status-green {color: #fff; background-color: #198754; font-weight: bold; padding: 4px 8px; border-radius: 5px;}
        .comment-btn {background: #ffc107; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 13px;}
        .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);}
        .modal-content {background: #fff; margin: 10% auto; padding: 20px; border-radius: 10px; width: 400px; box-shadow: 0 0 15px rgba(0,0,0,0.3);}
    </style>
</head>
<body>
    <div class="container">
        <img src="/static/logo.png" alt="Logo Int√©grale Academy" class="logo">
        <h2>üìã Gestion des demandes stagiaires</h2>
        <div id="last-update">‚è≥ Derni√®re mise √† jour : jamais</div>
        <div id="debug">‚è≥ En attente de donn√©es...</div>

        <table>
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Pr√©nom</th>
                    <th>T√©l√©phone</th>
                    <th>Email</th>
                    <th>Motif</th>
                    <th>D√©tails</th>
                    <th>Justificatif</th>
                    <th>Date</th>
                    <th>Attribu√© √†</th>
                    <th>Statut</th>
                    <th>Commentaire</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="demandes-body">
                <!-- rempli par JS -->
            </tbody>
        </table>
    </div>

    <!-- Fen√™tre modale -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <h3>üìù Commentaire</h3>
            <textarea id="modalComment" rows="6" style="width:100%;"></textarea>
            <div style="margin-top:10px; text-align:right;">
                <button type="button" onclick="closeCommentModal()">‚ùå Annuler</button>
                <button type="button" onclick="saveComment()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
    let currentCommentId = null;

    function openCommentModal(demandeId, commentaire) {
        currentCommentId = demandeId;
        document.getElementById("modalComment").value = commentaire;
        document.getElementById("commentModal").style.display = "block";
    }

    function closeCommentModal() {
        document.getElementById("commentModal").style.display = "none";
    }

    function saveComment() {
        if (currentCommentId) {
            let newComment = document.getElementById("modalComment").value;
            let hiddenInput = document.getElementById("commentaire-" + currentCommentId);
            hiddenInput.value = newComment;

            // Trouver le formulaire update de la ligne et le soumettre automatiquement
            let form = hiddenInput.closest("tr").querySelector("form[action=''][method='POST']");
            if (form) {
                // Forcer action=update
                form.querySelector("button[name='action'][value='update']").click();
            }
        }
        closeCommentModal();
    }

    function updateTable() {
        fetch("/api/demandes")
            .then(response => response.json())
            .then(data => {
                document.getElementById("debug").innerText =
                    "‚úÖ Donn√©es re√ßues : " + data.length + " demandes (√† " + new Date().toLocaleTimeString("fr-FR") + ")";

                let tbody = document.getElementById("demandes-body");
                let currentInputs = {};

                // sauvegarder saisies
                document.querySelectorAll("#demandes-body tr").forEach(row => {
                    let id = row.querySelector("input[name='id']")?.value;
                    if (id) {
                        currentInputs[id] = {
                            mail: row.querySelector("input[name='mail']").value,
                            details: row.querySelector("textarea[name='details']").value,
                            commentaire: row.querySelector("input[name='commentaire']").value,
                            attribution: row.querySelector("select[name='attribution']").value,
                            statut: row.querySelector("select[name='statut']").value
                        };
                    }
                });

                // reconstruire lignes
                let html = "";
                data.forEach(d => {
                    html += `
                    <tr>
                        <td>${d.nom}</td>
                        <td>${d.prenom}</td>
                        <td>${d.telephone}</td>
                        <td><input type="text" name="mail" value="${currentInputs[d.id]?.mail || d.mail}" style="width:95%;"></td>
                        <td>${d.motif}</td>
                        <td><textarea name="details" rows="3" style="width:95%;">${currentInputs[d.id]?.details || d.details}</textarea></td>
                        <td>${d.justificatif ? `<a href="/uploads/${d.justificatif}" target="_blank">üìé Voir</a>` : "-"}</td>
                        <td>${d.date}</td>
                        <td>
                            <select name="attribution">
                                <option value="">--</option>
                                <option value="Elsa" ${(currentInputs[d.id]?.attribution || d.attribution)=="Elsa" ? "selected":""}>Elsa</option>
                                <option value="Cl√©ment" ${(currentInputs[d.id]?.attribution || d.attribution)=="Cl√©ment" ? "selected":""}>Cl√©ment</option>
                            </select>
                        </td>
                        <td>
                            ${(currentInputs[d.id]?.statut || d.statut)=="Non trait√©"
                              ? '<span class="status-red">Non trait√©</span>'
                              : '<span class="status-green">Trait√©</span>'}
                            <select name="statut" style="margin-top:5px;">
                                <option value="Non trait√©" ${(currentInputs[d.id]?.statut || d.statut)=="Non trait√©" ? "selected":""}>Non trait√©</option>
                                <option value="Trait√©" ${(currentInputs[d.id]?.statut || d.statut)=="Trait√©" ? "selected":""}>Trait√©</option>
                            </select>
                            ${d.mail_confirme 
                              ? `<div style="font-size:12px; margin-top:4px;">
                                    <a href="/voir_mail/${d.id}" target="_blank" style="color:#198754; text-decoration:none;">
                                        ‚úÖ Mail envoy√© le ${d.mail_confirme}
                                    </a>
                                 </div>`
                              : (d.mail_erreur ? `<div style="font-size:12px; color:#dc3545; margin-top:4px;">${d.mail_erreur}</div>` : "")
                            }
                        </td>
                        <td>
                            <button type="button" class="comment-btn" onclick="event.preventDefault(); openCommentModal('${d.id}', \`${currentInputs[d.id]?.commentaire || d.commentaire || ""}\`)">‚úèÔ∏è Ajouter / Modifier</button>
                            <input type="hidden" name="commentaire" id="commentaire-${d.id}" value="${currentInputs[d.id]?.commentaire || d.commentaire || ""}">
                        </td>
                        <td class="actions">
                            <form method="POST" style="display:inline;">
                                <input type="hidden" name="id" value="${d.id}">
                                <input type="hidden" name="mail" value="${currentInputs[d.id]?.mail || d.mail}">
                                <input type="hidden" name="details" value="${currentInputs[d.id]?.details || d.details}">
                                <input type="hidden" name="commentaire" value="${currentInputs[d.id]?.commentaire || d.commentaire || ""}">
                                <input type="hidden" name="attribution" value="${currentInputs[d.id]?.attribution || d.attribution}">
                                <input type="hidden" name="statut" value="${currentInputs[d.id]?.statut || d.statut}">
                                <button type="submit" name="action" value="update" class="save">üíæ</button>
                            </form>
                            <form method="POST" style="display:inline;">
                                <input type="hidden" name="id" value="${d.id}">
                                <button type="submit" name="action" value="delete" class="delete">üóëÔ∏è</button>
                            </form>
                            <a href="/imprimer/${d.id}" target="_blank" class="print">üñ®Ô∏è</a>
                        </td>
                    </tr>`;
                });

                tbody.innerHTML = html;

                // maj horloge
                let now = new Date();
                let options = { timeZone: "Europe/Paris", hour: "2-digit", minute: "2-digit", second: "2-digit" };
                document.getElementById("last-update").innerText =
                    "‚è≥ Derni√®re mise √† jour : " + now.toLocaleDateString("fr-FR") + " " + now.toLocaleTimeString("fr-FR", options);
            })
            .catch(error => {
                document.getElementById("debug").innerText = "‚ùå Erreur updateTable : " + error;
            });
    }

    updateTable();
    setInterval(updateTable, 15000);
    </script>
</body>
</html>
